---
title: "Assignment_1"
output: pdf_document
date: "`r format(Sys.time(), '%d %B, %Y, %H:%M')`"
knit: (function(inputFile, encoding) { 
      out_dir <- '../output';
      rmarkdown::render(inputFile,
                        encoding=encoding, 
                        output_file=file.path(dirname(inputFile), 
                        out_dir, 'assignment_1.pdf')) })
---

```{r setup, include=FALSE}
library(tibble)
library(ggplot2)
library(dplyr)
library(haven)
library(moderndive)
library(broom)
library(lfe)
source("../../lib/R/ols_reg.R")
source("../../lib/R/iv_reg.R")
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE}
unzip("../raw/2012-0324_data.zip", exdir = "../temp")

gas_data <- read_dta("../temp/Web_materials/annual_regression_data.dta")
gas_data <- as_tibble(gas_data)
gas_data <- gas_data %>%
  filter(is.na(id) == FALSE)
gas_data <- mutate(gas_data,
                   observation_id         = row_number(),
                   real_gas_p             = ((taxin_gas_price)/cpi87),
                   real_gas_producer_p    = (taxin_gas_price - gas_tax_all)/cpi87,
                   ln_real_gas_producer_p = log(real_gas_producer_p),
                   ln_real_gas_p          = log(real_gas_p),
                   q_percapita            = (hug/pop_state_adj)*1000,
                   ln_q_percapita         = log(q_percapita),
                   real_gas_tax_state     = ((sgastax)/cpi87),
                   ln_real_gas_tax_state  = log(real_gas_tax_state),
                   realinc_percapita      = (realincome_state*1000/pop_state_adj),
                   ln_realinc_percapita   = log(realinc_percapita),
                   ln_real_oilprice       = log(real_oilprice))
real_state_tax_66 <- gas_data %>%
  filter(year == 1966) %>%
  select(state_num, real_gas_tax_state_66 = real_gas_tax_state)

gas_data <- left_join(gas_data, real_state_tax_66, "state_num") %>%
  mutate(instrument_demand_price = real_gas_tax_state_66 * real_oilprice)
gas_data <- gas_data %>%
  select(observation_id, year, state_num, state, ln_real_gas_p, ln_real_gas_producer_p, ln_q_percapita,
         real_gas_tax_state, ln_real_gas_tax_state, real_gas_tax_state_66, instrument_demand_price, 
         ln_real_oilprice, real_oilprice, realinc_percapita, ln_realinc_percapita, pop_state_adj, urbanization, 
         mining_gsp, road_mileage, railpop, unemployment) %>%
  arrange(state_num, year)

ln_q_percapita <- as.vector(gas_data$ln_q_percapita)
endogenous <- as.vector(gas_data$ln_real_gas_producer_p)
supply_regressors <- cbind(gas_data$ln_realinc_percapita, gas_data$real_gas_tax_state)
colnames(supply_regressors) <- c("ln_realinc_percapita", "real_gas_tax_state")
instruments_supply <- cbind(gas_data$urbanization, gas_data$railpop, gas_data$road_mileage)
colnames(instruments_supply) <- c("urbanization", "railpop", "road_mileage")
year <- as.vector(gas_data$year)
state <- as.vector(gas_data$state_num)
```

### Gasoline

## a) Estimate the elasticity of supply of gasoline. Provide a confidence interval. Can you reject the hypothesis that the supply of gasoline is elastic?

Our aim is to estimate $\theta = \frac{\partial G_{jt}}{\partial P^S_{jt}} \frac{P^S_{jt}}{G_{jt}}$. Where $G$ is the highway gasoline consumption per capita, $P^S$ is the real price of gasoline excluding taxes, and $j,t$ index state and year respectively. If we assume that the elasticity of supply is constant over time and across states. We can estimate a model of the form:

$\ln(G_{jt}) = \beta_0 + \beta_1 \ln(P^S_{jt}) + X'_{jt}\gamma + \eta_j + \eta_t + \epsilon_{jt}$

Where $X'_{jt}$ is a vector of supply related controls. In this model $\beta_1$ is a direct estimate for the price elasticity of supply. However, in order to estimate $\beta_1$ consistently, we cannot rely on OLS using the perfect competition equilibrium prices that we observe in the data. This is because, price and quantity are determined together through equating supply and demand, and therefore the real price of gasoline excluding taxes $P^S_{jt}$ is a function of the supply shocks $\epsilon_{jt}$. We therefore need a demand shifter that does not affect supplied quantity other than through the price change induced from the new demand. Hopefully, 

## c) 

```{r, echo = FALSE}

iv_estimate_supply_model <- felm(ln_q_percapita ~ 1 + ln_realinc_percapita + real_gas_tax_state
                                 | year + state_num | (ln_real_gas_producer_p ~ urbanization + road_mileage + railpop),
                                 data = gas_data)
year_fes <- getfe(iv_estimate_supply_model) %>%
  filter(fe == "year") %>%
  select(year = idx, effect)
ggplot(data = year_fes, aes(y = effect, x = year)) + geom_line(group = 1) + xlab("Year") + ylab("Year FE") + theme(axis.text.x=element_text(angle=90,vjust=0.5,hjust=1))
```

## d)

## e)
```{r, echo = FALSE}
iv_estimate_demand_model <- felm(ln_q_percapita ~ 1 + realinc_percapita + urbanization + real_gas_tax_state
                                |year + state_num|
                                (ln_real_gas_p ~ instrument_demand_price),
                                data = gas_data)
year_fes <- getfe(iv_estimate_demand_model) %>%
  filter(fe == "year") %>%
  select(year = idx, effect)
ggplot(data = year_fes, aes(y = effect, x = year)) + geom_line(group = 1) + 
  xlab("Year") + ylab("Year FE") + theme(axis.text.x=element_text(angle=90,vjust=0.5,hjust=1))
```

## i)
```{r, echo = FALSE}
ri_unemp <- gas_data %>%
  filter(state == "Rhode Island") %>%
  select(year, state_num, unemployment)
ggplot(data = ri_unemp, aes(y = unemployment, x = year)) + geom_line()

ri_unemp_fix <- ri_unemp %>%
  mutate(unemployment = case_when(year>= 1985 & year <= 2000 ~ unemployment*100,
                           TRUE ~ unemployment))
ggplot(data = ri_unemp_fix, aes(y = unemployment, x = year)) + geom_line()
```



