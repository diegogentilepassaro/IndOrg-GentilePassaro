%% Initialize
clear; close all; clc;

%% Set absolute path
cd '/Users/dgentil1/Desktop/Diego/Brown/Industrial Organization/IndOrg-GentilePassaro/assignment_0/code'

%% Input table
table = readtable('../temp/data_for_matlab.csv');

%% Regression analysis
EDUC = table.EDUC;
WAGE = table.LWKLYWGE;

% Model 1
X = horzcat(table.YR20, table.YR21, table.YR22, table.YR23, table.YR24, ...
    table.YR25, table.YR26, table.YR27, table.YR28);
Z = horzcat(table.QTR120, table.QTR121, table.QTR122, table.QTR123, ...
    table.QTR124, table.QTR125, table.QTR126, table.QTR127, table.QTR128, ...
    table.QTR129, table.QTR220, table.QTR221, table.QTR222, table.QTR223, ...
    table.QTR224, table.QTR225, table.QTR226, table.QTR227, table.QTR228, ...
    table.QTR229, table.QTR320, table.QTR321, table.QTR322, table.QTR323, ...
    table.QTR324, table.QTR325, table.QTR326, table.QTR327, table.QTR328, ...
    table.QTR329);

[beta_EDUC_m1, se_beta_EDUC_m1] = naive_mincerian_reg(WAGE, EDUC, X);
[iv_beta_EDUC_m1, iv_se_beta_EDUC_m1] = iv_mincerian_reg(WAGE, EDUC, Z, X);

% Model 2
X = horzcat(table.YR20, table.YR21, table.YR22, table.YR23, table.YR24, ...
    table.YR25, table.YR26, table.YR27, table.YR28, table.AGEQ, table.AGEQSQ);
Z = horzcat(table.QTR122, table.QTR123, table.QTR124, table.QTR125, ...
    table.QTR126, table.QTR127, table.QTR128, table.QTR129, table.QTR220, ...
    table.QTR221, table.QTR222, table.QTR223, table.QTR224, table.QTR225, ...
    table.QTR226, table.QTR227, table.QTR228, table.QTR229, table.QTR320, ...
    table.QTR321, table.QTR322, table.QTR323, table.QTR324, table.QTR325, ...
    table.QTR326, table.QTR327, table.QTR328, table.QTR329);

[beta_EDUC_m2, se_beta_EDUC_m2] = naive_mincerian_reg(WAGE, EDUC, X);
[iv_beta_EDUC_m2, iv_se_beta_EDUC_m2] = iv_mincerian_reg(WAGE, EDUC, Z, X);

% Model 3
X = horzcat(table.YR20, table.YR21, table.YR22, table.YR23, table.YR24, ...
    table.YR25, table.YR26, table.YR27, table.YR28, table.RACE, ...
    table.MARRIED, table.SMSA, table.NEWENG, table.MIDATL, table.ENOCENT, ...
    table.WNOCENT, table.SOATL, table.ESOCENT, table.WSOCENT, table.MT);
Z = horzcat(table.QTR120, table.QTR121, table.QTR122, table.QTR123, ...
    table.QTR124, table.QTR125, table.QTR126, table.QTR127, table.QTR128, ...
    table.QTR129, table.QTR220, table.QTR221, table.QTR222, table.QTR223, ...
    table.QTR224, table.QTR225, table.QTR226, table.QTR227, table.QTR228, ...
    table.QTR229, table.QTR320, table.QTR321, table.QTR322, table.QTR323, ...
    table.QTR324, table.QTR325, table.QTR326, table.QTR327, table.QTR328, ...
    table.QTR329);

[beta_EDUC_m3, se_beta_EDUC_m3] = naive_mincerian_reg(WAGE, EDUC, X);
[iv_beta_EDUC_m3, iv_se_beta_EDUC_m3] = iv_mincerian_reg(WAGE, EDUC, Z, X);

% Model 4
X = horzcat(table.YR20, table.YR21, table.YR22, table.YR23, table.YR24, ...
    table.YR25, table.YR26, table.YR27, table.YR28, table.RACE, ...
    table.MARRIED, table.SMSA, table.NEWENG, table.MIDATL, table.ENOCENT, ...
    table.WNOCENT, table.SOATL, table.ESOCENT, table.WSOCENT, table.MT, ...
    table.AGEQ, table.AGEQSQ);
Z = horzcat(table.QTR122, table.QTR123, table.QTR124, table.QTR125, ...
    table.QTR126, table.QTR127, table.QTR128, table.QTR129, table.QTR220, ...
    table.QTR221, table.QTR222, table.QTR223, table.QTR224, table.QTR225, ...
    table.QTR226, table.QTR227, table.QTR228, table.QTR229, table.QTR320, ...
    table.QTR321, table.QTR322, table.QTR323, table.QTR324, table.QTR325, ...
    table.QTR326, table.QTR327, table.QTR328, table.QTR329);

[beta_EDUC_m4, se_beta_EDUC_m4] = naive_mincerian_reg(WAGE, EDUC, X);
[iv_beta_EDUC_m4, iv_se_beta_EDUC_m4] = iv_mincerian_reg(WAGE, EDUC, Z, X);

% Logit Model
y_binary = table.EDUC_12;
nbr_obs = size(y_binary,1);
CONSTANT = ones(nbr_obs, 1);
X = horzcat(CONSTANT, table.AGEQ, table.AGEQSQ, table.QTR1);

nbr_betas = size(X,2);
initial_Beta = zeros(nbr_betas, 1);

Beta = fsolve(@(b)compute_FOC(b, X, y_binary), initial_Beta);
beta_QTR1 = Beta(nbr_betas,1);

X_allQTR1 = horzcat(CONSTANT, table.AGEQ, table.AGEQSQ, ones(nbr_obs,1));
p_allQTR1 = exp(X_allQTR1*Beta)./(1+exp(X_allQTR1*Beta));
X_noneQTR1 = horzcat(CONSTANT, table.AGEQ, table.AGEQSQ, zeros(nbr_obs,1));
p_noneQTR1 = exp(X_noneQTR1*Beta)./(1+exp(X_noneQTR1*Beta));
p_diff = p_allQTR1 - p_noneQTR1;

AME_QTR1 = sum(p_diff)/nbr_obs;


